在我们公司的业务场景中，有很大一部分用户是使用老款安卓机浏览页面，这些老款安卓机性能较差，如果优化不足，页面的卡顿现象会更加明显，此时页面性能优化的重要性就凸显出现。优化页面的性能，需要对浏览器的渲染过程有深入的了解，针对浏览器的每一步环节进行优化。

页面高性能的判断标准是 ` 60fps `。这是因为目前大多数设备的屏幕刷新率为 **60 次/秒**，也就是 ` 60fps ` , 如果刷新率降低，也就是说出现了掉帧, 对于用户来说，就是出现了卡顿的现象。

这就要求，页面每一帧的渲染时间仅为**16毫秒** (1 秒/ 60 = 16.66 毫秒)。但实际上，浏览器有其他工作要做，因此这一帧所有工作需要在 10毫秒内完成。如果工作没有完成，帧率将下降，并且内容会在屏幕上抖动。 此现象通常称为卡顿，会对用户体验产生负面影响。



# 浏览器渲染流程

浏览器一开始会从网络层获取请求文档的内容，请求过来的数据是 Bytes，然后浏览器将其编译成HTML的代码。

![](http://p8cyzbt5x.bkt.clouddn.com/UC20180705_005723.png)

但是我们写出来的HTML代码浏览器是看不懂的，所以需要进行解析。

![](http://p8cyzbt5x.bkt.clouddn.com/UC20180619_195129.png)

渲染引擎解析 HTML 文档，将各个dom标签逐个转化成“DOM tree”上的 DOM 节点。同时也会解析内部和外部的css, 解析为`CSSOM tree`, `css tree`和`dom tree`结合在一起生成了`render tree`。

`render tree`构建好之后，渲染引擎随后会经历一个`layout`的阶段: 计算出每一个节点应该出现在屏幕上的确切坐标。

之后的阶段被称为`paiting`阶段，渲染引擎会遍历`render tree`, 然后由用户界面后端层将每一个节点绘制出来。

最后一个阶段是 `composite` 阶段，这个阶段是合并图层。

![webkit 渲染引擎的主流程](http://p8cyzbt5x.bkt.clouddn.com/UC20180619_200256.png)



## 浏览器内核

浏览器是一个极其复杂庞大的软件。常见的浏览器有chrome, firefox。firefox是完全开源，Chrome不开源，但Chromium项目是部分开源。

> Chromium和Chrome之间的关系类似于尝鲜版和正式版的关系，Chromium会有很多新的不稳定的特性，待成熟稳定后会应用到Chrome。

浏览器功能有很多，包括网络、资源管理、网页浏览、多页面管理、插件和扩展、书签管理、历史记录管理、设置管理、下载管理、账户和同步、安全机制、隐私管理、外观主题、开发者工具等。

因此浏览器内部被划分为不同的模块。其中和页面渲染相关的，是下图中虚线框的部分渲染引擎。

![image-20180712105822858](http://p8cyzbt5x.bkt.clouddn.com/2018-07-12-025823.png)

渲染引擎的作用是将页面转变成可视化的图像结果。

目前，主流的渲染引擎包括**Trident**、**Gecko**和**WebKit**，它们分别是IE、火狐和Chrome的内核（2013年，Google宣布了Blink内核，它其实是从WebKit复制出去的），其中占有率最高的是 WebKit。

##  WebKit

最早，苹果公司和KDE开源社区产生了分歧，复制出一个开源的项目，就是WebKit。

WebKit被很多浏览器采用作为内核，其中就包括goole的chrome。

后来google公司又和苹果公司产生了分歧，google从webkit中复制出一个blink项目。

因此，blink内核和webkit内核没有特别的不同，因此很多老外会借用 chromium的实现来理解webkit的技术内幕，也是完全可以的。

## 浏览器源码

浏览器的代码非常的庞大，曾经有人尝试阅读Chromium项目的源码，git clone 到本地发现有10个G，光编译时间就3个小时（据说火狐浏览器编译需要更多的时间，大约为6个小时）。因此关于浏览器内部究竟是如何运作的，大部分的分享是浏览器厂商参与研发的内部员工。

国外有个非常有毅力的工程师[Tali Garsiel](https://www.html5rocks.com/profiles/#taligarsiel) 花费了n年的时间探究了浏览器的内幕，本文关于浏览器内部工作原理的介绍，主要整理自她的博客[how browser work](https://www.html5rocks.com/en/tutorials/internals/howbrowserswork/) , 和其他人的一些分享。

国内关于浏览器技术内幕主要有[《WebKit技术内幕》](https://read.douban.com/ebook/35765513/?dct=Web&type=paid&dcc=35765513&dcm=douban&dcs=updates)



在下面的系列文章中，我们将针对浏览器渲染的环节，深入理解浏览器内核做了哪些事情，逐一的介绍如何去进行前端页面的优化。



